<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi & Literasi</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Menggunakan font Inter dari Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Halaman Login -->
    <div id="login-page" class="min-h-screen flex items-center justify-center">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-xl shadow-lg text-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Selamat Datang</h1>
                <p class="mt-2 text-gray-500">Aplikasi Absensi & Literasi Siswa</p>
            </div>
            <!-- Login User -->
            <div class="pt-4">
                <h2 class="text-xl font-semibold text-gray-700">Masuk sebagai Siswa</h2>
                <p class="text-sm text-gray-500 mt-1">Isi absensi, lihat buku, dan capai target membacamu!</p>
                <button id="user-login-button" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                    Masuk Siswa
                </button>
            </div>
        </div>
    </div>

    <!-- Halaman Aplikasi Utama -->
    <div id="app-page" class="hidden w-full max-w-5xl mx-auto p-4 md:p-6">
        <div class="bg-white rounded-xl shadow-lg">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h1 id="app-title" class="text-2xl font-bold text-gray-800">Dasbor Siswa</h1>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-300">
                    Keluar
                </button>
            </div>
            
            <!-- Konten Aplikasi -->
            <div class="p-6">
                <!-- TABS UNTUK NAVIGASI -->
                <div class="border-b border-gray-200">
                    <nav id="tabs" class="-mb-px flex space-x-6" aria-label="Tabs">
                        <!-- Tab akan di-generate oleh JS -->
                    </nav>
                </div>

                <!-- KONTEN USER -->
                <div id="user-content">
                    <!-- Tab Absensi -->
                    <div id="absensi-tab-content" class="tab-content py-6">
                        <form id="attendance-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div class="space-y-4">
                                <div><label for="nama" class="block text-sm font-medium text-gray-700">Nama Lengkap</label><input type="text" id="nama" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg"></div>
                                <div><label for="kelas" class="block text-sm font-medium text-gray-700">Kelas</label><input type="text" id="kelas" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg"></div>
                                <div><label for="no_absen" class="block text-sm font-medium text-gray-700">Nomor Absen</label><input type="number" id="no_absen" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg"></div>
                            </div>
                            <div class="space-y-4">
                                <label class="block text-sm font-medium text-gray-700">Status Literasi Hari Ini</label>
                                <div class="flex items-center space-x-6 pt-1">
                                    <div class="flex items-center"><input id="sudah-baca" name="status_baca" type="radio" value="Sudah Baca" required class="h-4 w-4"><label for="sudah-baca" class="ml-2">Sudah Baca</label></div>
                                    <div class="flex items-center"><input id="belum-baca" name="status_baca" type="radio" value="Belum Baca" required class="h-4 w-4"><label for="belum-baca" class="ml-2">Belum Baca</label></div>
                                </div>
                                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition mt-6">Kirim Absensi</button>
                            </div>
                        </form>
                    </div>
                     <!-- Tab Daftar Buku -->
                    <div id="buku-tab-content" class="tab-content hidden py-6">
                        <div id="book-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Daftar buku akan di-generate oleh JS -->
                        </div>
                    </div>
                    <!-- Tab Target Mingguan -->
                    <div id="target-tab-content" class="tab-content hidden py-6">
                         <div class="bg-blue-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800">Target Membaca Mingguan</h3>
                            <div class="mt-4 flex items-center gap-4">
                                <input type="number" id="weekly-goal-input" min="1" class="w-24 p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 5">
                                <button id="set-goal-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Atur Target</button>
                            </div>
                            <div id="goal-progress" class="mt-6">
                                <!-- Progress bar akan di-generate oleh JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabel Data Absensi (Dilihat User & Admin) -->
                <div class="mt-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Data Kehadiran Terbaru</h2>
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kelas</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No. Absen</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Waktu</th></tr></thead><tbody id="attendance-table-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal untuk Tulis Ulasan -->
    <div id="review-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 id="review-modal-title" class="text-xl font-semibold mb-4">Tulis Ulasan untuk...</h3>
            <textarea id="review-textarea" class="w-full h-28 p-2 border border-gray-300 rounded-lg" placeholder="Bagaimana pendapatmu tentang buku ini?"></textarea>
            <div class="mt-4 flex justify-end gap-3">
                <button id="cancel-review-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg">Batal</button>
                <button id="submit-review-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Kirim</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === KUNCI & DATA ===
            const ATTENDANCE_KEY = 'attendanceData';
            const BOOKS_KEY = 'bookData';
            const GOAL_KEY = 'weeklyGoal';

            // Data buku contoh
            const sampleBooks = [
                { id: 1, title: 'Laskar Pelangi', author: 'Andrea Hirata', category: 'Remaja', reviews: [] },
                { id: 2, title: 'Bumi Manusia', author: 'Pramoedya Ananta Toer', category: 'Sejarah', reviews: [] },
                { id: 3, title: 'Si Kancil', author: 'Cerita Rakyat', category: 'Anak-anak', reviews: [] },
                { id: 4, title: 'Cantik Itu Luka', author: 'Eka Kurniawan', category: 'Dewasa', reviews: [] },
                { id: 5, title: 'Harry Potter', author: 'J.K. Rowling', category: 'Fantasi', reviews: [] },
                { id: 6, title: 'Gadis Kretek', author: 'Ratih Kumala', category: 'Fiksi', reviews: [] },
            ];
            
            // Inisialisasi data buku jika belum ada
            if (!localStorage.getItem(BOOKS_KEY)) {
                localStorage.setItem(BOOKS_KEY, JSON.stringify(sampleBooks));
            }

            // === REFERENSI ELEMEN ===
            const loginPage = document.getElementById('login-page');
            const appPage = document.getElementById('app-page');
            const userLoginBtn = document.getElementById('user-login-button');
            const logoutButton = document.getElementById('logout-button');
            const appTitle = document.getElementById('app-title');
            const tabsContainer = document.getElementById('tabs');
            const userContent = document.getElementById('user-content');
            const attendanceForm = document.getElementById('attendance-form');
            const attendanceTableBody = document.getElementById('attendance-table-body');
            const bookListContainer = document.getElementById('book-list');
            const reviewModal = document.getElementById('review-modal');
            const setGoalButton = document.getElementById('set-goal-button');

            // === FUNGSI UTAMA ===

            // 1. FUNGSI LOGIN & TAMPILAN
            function checkLoginStatus() {
                const isLoggedIn = sessionStorage.getItem('isLoggedIn');
                if (isLoggedIn) {
                    loginPage.classList.add('hidden');
                    appPage.classList.remove('hidden');
                    setupDashboard();
                } else {
                    appPage.classList.add('hidden');
                    loginPage.classList.remove('hidden');
                }
            }

            function setupDashboard() {
                renderAttendanceData();
                tabsContainer.innerHTML = '';
                const allTabs = document.querySelectorAll('.tab-content');
                allTabs.forEach(t => t.classList.add('hidden'));

                appTitle.textContent = 'Dasbor Siswa';
                userContent.classList.remove('hidden');

                const userTabs = [
                    { name: 'Isi Absensi', target: 'absensi-tab-content' },
                    { name: 'Daftar Buku', target: 'buku-tab-content' },
                    { name: 'Target Mingguan', target: 'target-tab-content' },
                ];
                renderTabs(userTabs);
                document.getElementById('absensi-tab-content').classList.remove('hidden');
                renderBooks();
                renderWeeklyGoal();
            }
            
            function renderTabs(tabs) {
                tabs.forEach((tab, index) => {
                    const button = document.createElement('button');
                    button.textContent = tab.name;
                    button.className = `tab-button py-3 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300`;
                    if (index === 0) button.classList.add('active');
                    
                    button.onclick = () => {
                        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                        document.getElementById(tab.target).classList.remove('hidden');
                    };
                    tabsContainer.appendChild(button);
                });
            }

            // 2. FUNGSI ABSENSI
            function renderAttendanceData() {
                attendanceTableBody.innerHTML = '';
                const data = JSON.parse(localStorage.getItem(ATTENDANCE_KEY) || '[]');
                if (data.length === 0) {
                    attendanceTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-gray-500">Belum ada data.</td></tr>`;
                    return;
                }
                data.sort((a, b) => new Date(b.waktu) - new Date(a.waktu));
                data.forEach(d => {
                    const date = new Date(d.waktu);
                    const formattedTime = date.toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${d.nama}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${d.kelas}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${d.no_absen}</td>
                        <td class="px-6 py-4 text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${d.status === 'Sudah Baca' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${d.status}</span></td>
                        <td class="px-6 py-4 text-sm text-gray-500">${formattedTime}</td>
                    `;
                    attendanceTableBody.appendChild(tr);
                });
            }

            // 3. FUNGSI BUKU & ULASAN
            function renderBooks() {
                bookListContainer.innerHTML = '';
                const books = JSON.parse(localStorage.getItem(BOOKS_KEY));
                books.forEach(book => {
                    const card = document.createElement('div');
                    card.className = 'bg-white border border-gray-200 rounded-lg p-4 flex flex-col';
                    let reviewsHtml = '<p class="text-xs text-gray-500 italic mt-3">Belum ada ulasan.</p>';
                    if (book.reviews.length > 0) {
                        reviewsHtml = book.reviews.map(r => `<div class="text-xs mt-2 p-2 bg-gray-50 rounded"><p>${r}</p></div>`).join('');
                    }
                    card.innerHTML = `
                        <div class="flex-grow">
                            <span class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${book.category}</span>
                            <h4 class="font-bold text-gray-800 mt-2">${book.title}</h4>
                            <p class="text-sm text-gray-500">${book.author}</p>
                            <h5 class="text-xs font-semibold mt-4 mb-1">Ulasan:</h5>
                            <div class="max-h-20 overflow-y-auto">${reviewsHtml}</div>
                        </div>
                        <button data-book-id="${book.id}" class="write-review-btn mt-4 w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-3 rounded-lg text-sm">Tulis Ulasan</button>
                    `;
                    bookListContainer.appendChild(card);
                });
            }

            function openReviewModal(bookId) {
                const books = JSON.parse(localStorage.getItem(BOOKS_KEY));
                const book = books.find(b => b.id == bookId);
                reviewModal.querySelector('#review-modal-title').textContent = `Tulis Ulasan untuk "${book.title}"`;
                reviewModal.querySelector('#review-textarea').value = '';
                reviewModal.querySelector('#submit-review-button').dataset.bookId = bookId;
                reviewModal.classList.remove('hidden');
            }

            // 4. FUNGSI TARGET MINGGUAN
            function renderWeeklyGoal() {
                const goalData = JSON.parse(localStorage.getItem(GOAL_KEY) || '{}');
                const target = goalData.target || 0;
                const progress = goalData.progress || 0;
                const percentage = target > 0 ? (progress / target) * 100 : 0;

                const progressContainer = document.getElementById('goal-progress');
                document.getElementById('weekly-goal-input').value = target > 0 ? target : '';

                progressContainer.innerHTML = `
                    <p class="text-sm text-gray-600">Progres Kamu: <span class="font-bold">${progress} dari ${target}</span> buku/artikel terbaca.</p>
                    <div class="w-full bg-gray-200 rounded-full h-4 mt-2">
                        <div class="bg-green-500 h-4 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                `;
            }
            
            function updateGoalProgress() {
                const goalData = JSON.parse(localStorage.getItem(GOAL_KEY) || '{ "target": 0, "progress": 0 }');
                const lastUpdate = goalData.lastUpdate ? new Date(goalData.lastUpdate) : new Date(0);
                const now = new Date();

                // Reset progress jika sudah minggu baru
                const lastUpdateWeek = Math.floor((lastUpdate.getTime() - lastUpdate.getTimezoneOffset() * 60000) / (1000 * 60 * 60 * 24 * 7));
                const nowWeek = Math.floor((now.getTime() - now.getTimezoneOffset() * 60000) / (1000 * 60 * 60 * 24 * 7));
                
                if (nowWeek > lastUpdateWeek) {
                    goalData.progress = 0;
                }

                goalData.progress = (goalData.progress || 0) + 1;
                goalData.lastUpdate = now.toISOString();
                localStorage.setItem(GOAL_KEY, JSON.stringify(goalData));
            }


            // === EVENT LISTENERS ===
            userLoginBtn.addEventListener('click', () => {
                sessionStorage.setItem('isLoggedIn', 'true');
                checkLoginStatus();
            });

            logoutButton.addEventListener('click', () => {
                sessionStorage.removeItem('isLoggedIn');
                checkLoginStatus();
            });

            attendanceForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newEntry = {
                    nama: document.getElementById('nama').value.trim(),
                    kelas: document.getElementById('kelas').value.trim(),
                    no_absen: document.getElementById('no_absen').value,
                    status: document.querySelector('input[name="status_baca"]:checked').value,
                    waktu: new Date().toISOString()
                };
                
                const data = JSON.parse(localStorage.getItem(ATTENDANCE_KEY) || '[]');
                data.push(newEntry);
                localStorage.setItem(ATTENDANCE_KEY, JSON.stringify(data));
                
                if (newEntry.status === 'Sudah Baca') {
                    updateGoalProgress();
                    renderWeeklyGoal();
                }

                renderAttendanceData();
                attendanceForm.reset();
            });
            
            bookListContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('write-review-btn')) {
                    const bookId = e.target.dataset.bookId;
                    openReviewModal(bookId);
                }
            });
            
            reviewModal.querySelector('#cancel-review-button').addEventListener('click', () => reviewModal.classList.add('hidden'));
            
            reviewModal.querySelector('#submit-review-button').addEventListener('click', (e) => {
                const bookId = e.target.dataset.bookId;
                const reviewText = reviewModal.querySelector('#review-textarea').value.trim();
                if (reviewText) {
                    const books = JSON.parse(localStorage.getItem(BOOKS_KEY));
                    const bookIndex = books.findIndex(b => b.id == bookId);
                    books[bookIndex].reviews.push(reviewText);
                    localStorage.setItem(BOOKS_KEY, JSON.stringify(books));
                    renderBooks();
                    reviewModal.classList.add('hidden');
                }
            });
            
            setGoalButton.addEventListener('click', () => {
                const target = document.getElementById('weekly-goal-input').value;
                if(target && target > 0) {
                    const goalData = JSON.parse(localStorage.getItem(GOAL_KEY) || '{}');
                    goalData.target = parseInt(target);
                    // Tidak reset progress saat target diubah di tengah minggu
                    if(goalData.progress === undefined) goalData.progress = 0;
                    localStorage.setItem(GOAL_KEY, JSON.stringify(goalData));
                    renderWeeklyGoal();
                }
            });

            // Jalankan pengecekan login saat halaman dimuat
            checkLoginStatus();
        });
    </script>
</body>
</html>